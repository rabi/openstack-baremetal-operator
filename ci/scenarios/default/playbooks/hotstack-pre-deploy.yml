---
- name: Configure content provider insecure registry on hotstack OCP cluster
  hosts: hotstack
  gather_facts: false
  vars:
    hotstack_work_dir: "{{ ansible_user_dir }}/hotstack"
  tasks:
    - name: Configure insecure registry
      when: content_provider_registry_ip is defined
      block:
        - name: Set content provider registry
          ansible.builtin.set_fact:
            content_provider_registry: "{{ content_provider_registry_ip }}:5001"

        - name: Fetch stack outputs from remote to zuul executor
          no_log: true
          ansible.builtin.fetch:
            src: "{{ hotstack_work_dir }}/hs-{{ zuul.build }}-outputs.yaml"
            dest: "{{ zuul.executor.work_root }}/hs-{{ zuul.build }}-outputs.yaml"
            flat: true

        - name: Load stack output vars
          no_log: true
          ansible.builtin.include_vars:
            file: "{{ zuul.executor.work_root }}/hs-{{ zuul.build }}-outputs.yaml"
            name: stack_outputs

        - name: Add Hotstack controller-0 to ansible inventory
          no_log: true
          ansible.builtin.add_host: "{{ stack_outputs.controller_ansible_host }}"

        - name: Wait for Hotstack controller-0 to be ready
          no_log: true
          delegate_to: "{{ stack_outputs.controller_ansible_host.name }}"
          ansible.builtin.wait_for_connection:
            delay: 5
            timeout: 300

        - name: Configure insecure registry on OCP cluster
          delegate_to: "{{ stack_outputs.controller_ansible_host.name }}"
          block:
            - name: Patch image.config to add insecure and allowed registries
              ansible.builtin.command:
                cmd: >-
                  oc patch image.config.openshift.io/cluster --type=merge -p
                  '{"spec":{"registrySources":{"insecureRegistries":["{{ content_provider_registry }}"],
                  "allowedRegistries":["{{ content_provider_registry }}",
                  "quay.io","registry.redhat.io","image-registry.openshift-image-registry.svc:5000",
                  "registry.ci.openshift.org","ghcr.io","gcr.io","docker.io"]}}}'
              changed_when: true

            - name: Wait for MachineConfigPool to start updating
              ansible.builtin.command:
                cmd: >-
                  oc wait mcp master
                  --for=condition=Updating=True --timeout=300s
              changed_when: false
              failed_when: false

            - name: Wait for MachineConfigPool update to complete
              ansible.builtin.command:
                cmd: >-
                  oc wait mcp master
                  --for=condition=Updated=True --timeout=1800s
              changed_when: false

            - name: Wait for API server to become available
              ansible.builtin.command:
                cmd: oc get nodes
              register: _api_check
              until: _api_check.rc == 0
              retries: 20
              delay: 30
              changed_when: false

            - name: Wait for all nodes to be Ready
              ansible.builtin.command:
                cmd: >-
                  oc wait nodes --all --for=condition=Ready --timeout=600s
              changed_when: false

            - name: Wait for cluster operators to stabilize
              ansible.builtin.command:
                cmd: >-
                  oc wait co --all --for=condition=Available=True --timeout=600s
              changed_when: false

            - name: Verify insecure registry is configured
              ansible.builtin.command:
                cmd: >-
                  oc get image.config.openshift.io/cluster
                  -o jsonpath='{.spec.registrySources.insecureRegistries}'
              register: _insecure_registries
              failed_when: content_provider_registry not in _insecure_registries.stdout
              changed_when: false

            - name: Log configured insecure registries
              ansible.builtin.debug:
                var: _insecure_registries.stdout
